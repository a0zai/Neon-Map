<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Spraak Navigatie Assistent</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <style>
    body { margin: 0; background: #000; }
    iframe { width: 100vw; height: 100vh; border: none; }
  </style>
</head>
<body>

<iframe id="map"></iframe>

<script>
let started = false;

// ðŸŽ™ï¸ Ø§Ù„Ù†Ø·Ù‚ Ø§Ù„ØµÙˆØªÙŠ
function speak(text, callback) {
  speechSynthesis.cancel();
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "nl-NL";
  msg.rate = 1;
  msg.pitch = 1;
  const voices = speechSynthesis.getVoices();
  const humanVoice = voices.find(v => v.lang === "nl-NL" && v.name.toLowerCase().includes("google")) || voices[0];
  if(humanVoice) msg.voice = humanVoice;
  msg.onend = callback;
  speechSynthesis.speak(msg);
}

// ðŸŽ§ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
function startListening() {
  if(!('webkitSpeechRecognition' in window)){
    speak("Deze browser ondersteunt geen spraakherkenning.");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "nl-NL";
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.start();

  recognition.onresult = async (event) => {
    const text = event.results[0][0].transcript;
    speak("Ik zoek naar " + text);

    // ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    document.getElementById("map").src =
      "https://www.google.com/maps?q=" + encodeURIComponent(text) + "&output=embed";

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ÙˆØ¬Ù‡Ø© (Geocoding API Ù…Ø¬Ø§Ù†ÙŠ Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù‡Ù†Ø§ Ù…Ø¬Ø±Ø¯ ØªØ¬Ø±Ø¨Ø©)
    const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(text)}`;
    try {
      const res = await fetch(geocodeUrl);
      const data = await res.json();
      if(data && data[0]){
        const destLat = parseFloat(data[0].lat);
        const destLng = parseFloat(data[0].lon);
        startNavigation(destLat, destLng);
      }
    } catch(e){ console.log(e); }

    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
    setTimeout(startListening, 1500);
  };

  recognition.onerror = () => { speak("Ik heb u niet goed verstaan.", ()=>setTimeout(startListening,1500)); };
  recognition.onend = () => { if(!speechSynthesis.speaking) setTimeout(startListening,1500); };
}

// ðŸ§­ ØªÙˆØ¬ÙŠÙ‡ Ø¨Ø§Ù„Ø³Ø§Ø¹Ø© ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©
function startNavigation(destLat, destLng){
  if(!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(function getPos(pos){
    const userLat = pos.coords.latitude;
    const userLng = pos.coords.longitude;

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨Ø§Ù„Ù…ØªØ±
    function getDistance(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const toRad = x=>x*Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
      return R*c;
    }

    // Ø­Ø³Ø§Ø¨ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø³Ø§Ø¹Ø©
    function getClockDirection(lat1, lon1, lat2, lon2){
      const toDeg = x => x*180/Math.PI;
      const y = Math.sin(lon2-lon1)*Math.cos(lat2);
      const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(lon2-lon1);
      let brng = (toDeg(Math.atan2(y,x))+360)%360;
      const hour = Math.round(brng/30) || 12;
      return hour;
    }

    const distance = Math.round(getDistance(userLat,userLng,destLat,destLng));
    const hour = getClockDirection(userLat,userLng,destLat,destLng);

    if(distance > 10){
      speak(`Na ${distance} meter, sla af bij uur ${hour}`, ()=>{
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
        setTimeout(()=>startNavigation(destLat,destLng),10000);
      });
    }else{
      speak("U bent aangekomen op uw bestemming.");
    }
  });
}

// ðŸ‘† Ø£ÙˆÙ„ Ù†Ù‚Ø±Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
document.body.addEventListener("click",()=>{
  if(started) return;
  started=true;
  speak("Toestemming gevraagd. Zeg nu uw bestemming.", ()=>startListening());
});

// ðŸ”Š ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø£ÙˆÙ„ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹
window.onload = ()=>{ speak("Tik Ã©Ã©n keer in het midden van het scherm om de microfoon toe te staan."); };

// ØªØ³Ø¬ÙŠÙ„ Service Worker
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js").catch(err=>console.log("Service Worker registration failed: ",err));
}
</script>

</body>
</html>